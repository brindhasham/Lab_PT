import win32service
import subprocess
import logging
import csv
import os
from datetime import datetime

# Get script directory
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))

# Set paths for CSV and log file
CSV_FILE = os.path.join(SCRIPT_DIR, "vulnerable_services.csv")
LOG_FILE = os.path.join(SCRIPT_DIR, "service_exploit.log")

# Setup logging
logging.basicConfig(filename=LOG_FILE, level=logging.INFO)

# Store results in memory for post-scan summary
vulnerable_services = []

def check_service_exploit(service_name):
    try:
        scm_handle = win32service.OpenSCManager(None, None, win32service.SC_MANAGER_ALL_ACCESS)
        service_handle = win32service.OpenService(scm_handle, service_name, win32service.SERVICE_QUERY_CONFIG)
        config = win32service.QueryServiceConfig(service_handle)
        binary_path = config[3]

        win32service.CloseServiceHandle(service_handle)
        win32service.CloseServiceHandle(scm_handle)

        result = subprocess.run(f'icacls "{binary_path}"', capture_output=True, text=True)

        if 'Everyone:(F)' in result.stdout or 'Users:(F)' in result.stdout:
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            print(f"[+] Vulnerable: {service_name}")
            vulnerable_services.append((service_name, binary_path, timestamp))
            logging.info(f"Vulnerable service: {service_name}, Path: {binary_path}")
            with open(CSV_FILE, 'a', newline='') as csvfile:
                writer = csv.writer(csvfile)
                writer.writerow([service_name, binary_path, timestamp])
        else:
            print(f"[-] Not vulnerable: {service_name}")
            logging.info(f"Not vulnerable: {service_name}")

    except Exception as e:
        print(f"[!] Error checking {service_name}: {e}")
        logging.error(f"Error checking {service_name}: {e}")

def scan_all_services():
    print(f"\n[~] Starting service scan...\n")
    scm = win32service.OpenSCManager(None, None, win32service.SC_MANAGER_ENUMERATE_SERVICE)
    services = win32service.EnumServicesStatus(scm, win32service.SERVICE_WIN32, win32service.SERVICE_STATE_ALL)
    win32service.CloseServiceHandle(scm)

    with open(CSV_FILE, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        writer.writerow(["Service Name", "Binary Path", "Timestamp"])

    for svc in services:
        service_name = svc[0]
        check_service_exploit(service_name)

    print(f"\n[âœ“] Scanning complete.")

    if vulnerable_services:
        print(f"\n[+] Vulnerable services found:")
        for name, path, time in vulnerable_services:
            print(f"    - {name}\n      Path: {path}\n      Time: {time}\n")
    else:
        print("[+] No vulnerable services detected.")

    print(f"[~] Results saved to: {CSV_FILE}")
    print(f"[~] Log file saved to: {LOG_FILE}\n")

if __name__ == "__main__":
    scan_all_services()

